{"version":3,"file":"26-manipulating-views.js","sourceRoot":"","sources":["../../src/test/26-manipulating-views.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from \"chai\";\nimport { Database } from \"../database\";\nimport { ArangoSearchView } from \"../view\";\n\nconst ARANGO_URL = process.env.TEST_ARANGODB_URL || \"http://localhost:8529\";\nconst ARANGO_VERSION = Number(\n  process.env.ARANGO_VERSION || process.env.ARANGOJS_DEVEL_VERSION || 30400\n);\nconst describe34 = ARANGO_VERSION >= 30400 ? describe : describe.skip;\n\ndescribe34(\"Manipulating views\", function () {\n  const name = `testdb_${Date.now()}`;\n  let db: Database;\n  let view: ArangoSearchView;\n  before(async () => {\n    db = new Database({ url: ARANGO_URL, arangoVersion: ARANGO_VERSION });\n    await db.createDatabase(name);\n    db.useDatabase(name);\n  });\n  after(async () => {\n    try {\n      db.useDatabase(\"_system\");\n      await db.dropDatabase(name);\n    } finally {\n      db.close();\n    }\n  });\n  beforeEach(async () => {\n    view = db.view(`v-${Date.now()}`);\n    await view.create();\n  });\n  afterEach(async () => {\n    try {\n      await view.get();\n    } catch (e) {\n      return;\n    }\n    await view.drop();\n  });\n  describe(\"view.create\", () => {\n    it(\"creates a new arangosearch view\", async () => {\n      const view = db.view(`asv-${Date.now()}`);\n      await view.create();\n      const info = await view.get();\n      expect(info).to.have.property(\"name\", view.name);\n      expect(info).to.have.property(\"type\", \"arangosearch\");\n    });\n  });\n  describe(\"view.updateProperties\", () => {\n    it(\"should change properties\", async () => {\n      const oldProps = await view.updateProperties({\n        consolidationIntervalMsec: 45000,\n        consolidationPolicy: { type: \"tier\" },\n      });\n      expect(oldProps.consolidationIntervalMsec).to.equal(45000);\n      expect(oldProps.consolidationPolicy).to.have.property(\"type\", \"tier\");\n      const properties = await view.updateProperties({\n        consolidationPolicy: { type: \"bytes_accum\" },\n      });\n      expect(properties.consolidationIntervalMsec).to.equal(45000);\n      expect(properties.consolidationPolicy).to.have.property(\n        \"type\",\n        \"bytes_accum\"\n      );\n    });\n  });\n  describe(\"view.replaceProperties\", () => {\n    it(\"should change properties\", async () => {\n      const initial = await view.properties();\n      expect(initial.consolidationIntervalMsec).not.to.equal(45000);\n      const oldProps = await view.replaceProperties({\n        consolidationIntervalMsec: 45000,\n        consolidationPolicy: { type: \"tier\" },\n      });\n      expect(oldProps.consolidationIntervalMsec).to.equal(45000);\n      expect(oldProps.consolidationPolicy).to.have.property(\"type\", \"tier\");\n      const properties = await view.replaceProperties({\n        consolidationPolicy: { type: \"bytes_accum\" },\n      });\n      expect(properties.consolidationIntervalMsec).to.equal(\n        initial.consolidationIntervalMsec\n      );\n      expect(properties.consolidationPolicy).to.have.property(\n        \"type\",\n        \"bytes_accum\"\n      );\n    });\n  });\n  describe(\"view.rename\", () => {\n    it(\"should rename a view\", async () => {\n      const res = await db.route(\"/_admin/server/role\").get();\n      if (res.body.role !== \"SINGLE\") {\n        console.warn(\"Skipping rename view test in cluster\");\n        return;\n      }\n      const name = `v2-${Date.now()}`;\n      const info = await view.rename(name);\n      expect(info).to.have.property(\"name\", name);\n    });\n  });\n  describe(\"view.drop\", () => {\n    it(\"should drop a view\", async () => {\n      await view.drop();\n      try {\n        await view.get();\n      } catch (e) {\n        expect(e).to.have.property(\"errorNum\", 1203);\n        return;\n      }\n      expect.fail(\"should throw\");\n    });\n  });\n});\n"]}